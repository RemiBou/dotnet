@using StackExchange.Profiling
@using System.IO
@using StackExchange.Profiling.Internal
@inject HttpClient Http
@inject IJSRuntime jsRuntime
@inject BlazorProfilerProvider BlazorProfilerProvider;
@inject MiniProfilerJsInterop MiniProfilerJsInterop;
<div id="mini-profiler" data-ids="" data-authorized="true" data-position="right" data-controls="true" data-version="@MiniProfilerBaseOptions.Version"></div>
<script type="text/javascript" suppress-error="BL9992">@js</script>
<style type="text/css">@css</style>
@if(MiniProfiler.Current != null)
{
    <button @onclick="Stop">Stop Profiling</button>
} else {
    <button @onclick="Start">Start Profiling</button>
}

@code {
    private string js = "";
    private string css;
    protected async Task Stop(){
        
        await MiniProfiler.Current.StopAsync();
    }
    protected async Task Start(){
        MiniProfiler.DefaultOptions.StartProfiler();
    }
    protected override async Task OnInitializedAsync(){
        MiniProfiler.DefaultOptions.StartProfiler();
        var assembly = typeof(MiniProfiler).Assembly;
        using(MiniProfiler.Current.Step("Blazor MiniProfiler : CSS Loading"))
        {
            using (var stream = assembly.GetManifestResourceStream("StackExchange.Profiling.ui.includes.min.css"))                    
            using (var reader = new StreamReader(stream))
            {
                css += await reader.ReadToEndAsync();
            }
        }
        using(MiniProfiler.Current.Step("Blazor MiniProfiler : JS Loading"))
        {
            using (var stream = assembly.GetManifestResourceStream("StackExchange.Profiling.ui.includes.min.js"))                    
            using (var reader = new StreamReader(stream))
            {
                js += await reader.ReadToEndAsync();
                //await jsRuntime.InvokeVoidAsync("eval", js);
            }
        }
        
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(!firstRender){
            return;
        }
        BlazorProfilerProvider.OnProfilerStopped += (target,miniProfiler) => {
            Console.WriteLine("OnProfilerStopped"+miniProfiler.Id);
            MiniProfilerJsInterop.RenderProfiler(miniProfiler).ContinueWith((t) => {});
        };
        
    }

}